<script type="text/babel">
  const { useState } = React;

  const categoriesConfig = {
    'unterhaltung': { title: 'UNTERHALTNG', handouts: [{ id: 'ard-audiothek', title:'ARD Audiothek' }, { id: 'spotify', title:'Spotify' }]},
    'digitaler-alltag': { title: 'DIGITALER ALLTAG', handouts: [
      {id:'notfallpass-android', title:'Notfallpass Android'},
      {id:'notfallpass-iphone', title:'Notfallpass iPhone'},
      {id:'online-banking', title:'Online Banking'},
      {id:'db-app', title:'DB App'},
      {id:'lieferdienste', title:'Lieferdienste'},
      {id:'online-shops', title:'Online Shops'},
      {id:'flaschenpost', title:'Flaschenpost'},
      {id:'doctolib', title:'Doctolib'},
      {id:'payback-app', title:'Payback App'},
      {id:'mytherapy', title:'MyTherapy'},
      {id:'e-rezept-gesundde', title:'E-Rezept Gesund.de'}
    ]},
    'sicherheit': { title: 'SICHERHEIT', handouts: [
      {id:'adblocker-antivirus', title:'Adblocker und Antivirus'},
      {id:'chrome-werbung-blockieren', title:'Chrome Werbung blockieren'},
      {id:'samsung-browser-werbung-blockieren', title:'Samsung Browser Werbung blockieren'},
      {id:'xiaomi-werbung', title:'Sonder Xiaomi Werbung'},
      {id:'safari-einstellungen', title:'Safari Einstellungen'},
      {id:'online-betrug', title:'Online-Betrug'},
      {id:'passwortmanager', title:'Passwortmanager Handout'}
    ]},
    'handy-grundlagen': { title:'HANDY GRUNDLAGEN', handouts: [
      {id:'e-mails', title:'E-Mails lesen und schreiben'},
      {id:'fotos-whatsapp', title:'Fotos versenden WhatsApp'},
      {id:'kalendereintrag', title:'Kalendereintrag'},
      {id:'loeschungen-android', title:'Löschungen auf dem Android'},
      {id:'updates-handy', title:'Updates auf dem Handy installieren'},
      {id:'app-installieren-android', title:'App Installieren Android'},
      {id:'qr-code-android', title:'QR-Code Android'},
      {id:'qr-code-ios', title:'QR-Code iOS'},
      {id:'loeschungen-iphone', title:'Löschungen auf einem iPhone durchführen'},
      {id:'datenuebertragung-android', title:'Datenübertragung Android'},
      {id:'datenuebertragung-android-kurz', title:'Datenübertragung Android Kurz'},
      {id:'datenuebertragung-iphone', title:'Datenübertragung iPhone'},
      {id:'datenuebertragung-vergleich', title:'Datenübertragung Android vs iPhone'}
    ]}
  };

  const HomeIcon = () => (<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>);
  const ArrowLeft = () => (<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>);
  const ArrowRight = () => (<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>);

  function App(){
    const [view, setView] = useState('categories');
    const [selectedCategory, setSelectedCategory] = useState(null);
    const [selectedHandout, setSelectedHandout] = useState(null);
    const [currentPage, setCurrentPage] = useState(0);
    const [isZoomed, setIsZoomed] = useState(false);
    const [availablePages, setAvailablePages] = useState([]);
    const [imageError, setImageError] = useState(false);
    const [isLoading, setIsLoading] = useState(false);

    // geht zur Startseite (Kategorien)
    const goHome = () => {
      setView('categories');
      setSelectedCategory(null);
      setSelectedHandout(null);
      setCurrentPage(0);
      setIsZoomed(false);
      setAvailablePages([]);
      setImageError(false);
    };

    // neues: "Zurück"-Funktion: im Viewer zurück zur Handout-Liste der ursprünglichen Kategorie
    const goBack = () => {
      if (view === 'viewer') {
        // zurück zur Handout-Liste der selektierten Kategorie — selectedCategory bleibt erhalten
        setView('handouts');
        setSelectedHandout(null);
        setCurrentPage(0);
        setIsZoomed(false);
        setAvailablePages([]);
        setImageError(false);
      } else {
        // sonst zur Startseite (Kategorien)
        goHome();
      }
    };

    const selectCategory = (categoryId) => { setSelectedCategory(categoryId); setView('handouts'); };
    const selectHandout = async (handout, categoryId) => {
      setIsLoading(true);
      setSelectedHandout({ ...handout, categoryId });
      setCurrentPage(0);
      setView('viewer');
      setIsZoomed(false);
      const pages = await loadAvailablePages(categoryId, handout.id);
      setAvailablePages(pages);
      setIsLoading(false);
    };

    const loadAvailablePages = async (categoryId, handoutId) => {
      const extensions = ['jpg','jpeg','png'];
      const foundPages = [];
      for (let i=1;i<=20;i++){
        let pageFound = false;
        for (let ext of extensions){
          const filename = `bilder/${categoryId}_${handoutId}_${i}.${ext}`;
          try {
            const exists = await checkImageExists(filename);
            if (exists) { foundPages.push(filename); pageFound = true; break; }
          } catch(e){}
        }
        if (!pageFound) break;
      }
      return foundPages;
    };

    const checkImageExists = (url) => new Promise((resolve)=>{
      const img = new Image();
      const timeout = setTimeout(()=>{ img.src=''; resolve(false); }, 3000);
      img.onload = ()=>{ clearTimeout(timeout); resolve(true); };
      img.onerror = ()=>{ clearTimeout(timeout); resolve(false); };
      img.src = url;
    });

    const nextPage = ()=>{ if (currentPage < availablePages.length -1){ setCurrentPage(currentPage+1); setIsZoomed(false); setImageError(false);} };
    const prevPage = ()=>{ if (currentPage > 0){ setCurrentPage(currentPage-1); setIsZoomed(false); setImageError(false);} };
    const toggleZoom = ()=>{ if (!imageError) setIsZoomed(!isZoomed); };
    const handleImageError = ()=> setImageError(true);
    const handleImageLoad = ()=> setImageError(false);

    return (
      <>
        {/* Button zeigt je nach Ansicht Home oder Zurück */}
        {view !== 'categories' && (
          <button
            className="home-button"
            onClick={goBack}
            aria-label={view === 'viewer' ? 'Zurück zur Kategorie' : 'Home'}>
            {view === 'viewer' ? <ArrowLeft /> : <HomeIcon />}
          </button>
        )}

        {view === 'categories' && (
          <>
            <h1 className="title">Kategorien</h1>
            <div className="category-grid">
              {Object.keys(categoriesConfig).map(categoryId => (
                <button key={categoryId} className="category-button" onClick={()=>selectCategory(categoryId)}>
                  {categoriesConfig[categoryId].title}
                </button>
              ))}
            </div>
          </>
        )}

        {view === 'handouts' && selectedCategory && (
          <>
            <h1 className="title">{categoriesConfig[selectedCategory].title}</h1>
            <div className="category-grid">
              {categoriesConfig[selectedCategory].handouts.map((handout, index)=>(
                <button key={index} className="handout-button" onClick={()=>selectHandout(handout, selectedCategory)}>{handout.title}</button>
              ))}
            </div>
          </>
        )}

        {view === 'viewer' && selectedHandout && (
          <div className="viewer-container">
            {isLoading ? <div className="loading">Lade Bilder...</div> :
             availablePages.length === 0 ? (
               <div className="error-message">
                 ❌ Keine Bilder gefunden<br/><br/>
                 Erwarteter Pfad:<br/>
                 <strong style={{color:'#333', fontSize:'14px', display:'inline-block', marginTop:'10px', padding:'8px 16px', background:'#f0f0f0', borderRadius:'8px', border:'1px solid #d0d0d0'}}>
                   bilder/{selectedHandout.categoryId}_{selectedHandout.id}_1.jpg
                 </strong>
                 <br/><br/>
                 <span style={{fontSize:'14px', color:'#666'}}>Erstellen Sie einen Ordner "bilder" neben der HTML-Datei und legen Sie dort Ihre Bilder ab.</span>
               </div>
             ) : (
               <>
                 <div className={`image-viewer ${isZoomed ? 'zoomed' : ''}`}>
                   {imageError ? <div className="error-message">Bild konnte nicht geladen werden</div> :
                     <img src={availablePages[currentPage]} alt={`Schritt ${currentPage+1}`} onClick={toggleZoom} onError={handleImageError} onLoad={handleImageLoad} />}
                 </div>
                 <div className="navigation">
                   <button className="nav-button" onClick={prevPage} disabled={currentPage===0}><ArrowLeft /></button>
                   <div className="page-indicator">Schritt {currentPage+1} von {availablePages.length}</div>
                   <button className="nav-button" onClick={nextPage} disabled={currentPage===availablePages.length-1}><ArrowRight /></button>
                 </div>
               </>
             )}
          </div>
        )}
      </>
    );
  }

  ReactDOM.render(<App />, document.getElementById('app'));
</script>
